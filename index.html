<!DOCTYPE html>
<html lang="en"> <!-- class="dark" is set by script -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Huginn - Cardano On-Chain Polling (CIP-Aligned)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Almendra&display=swap" rel="stylesheet">
    <style>
        /* --- THEMEING APPROACH WITH CSS VARIABLES --- */
        :root {
            /* Light Theme Palette */
            --bg-body: #e5e7eb; /* gray-200 */
            --bg-panel: rgba(255, 255, 255, 0.8);
            --bg-panel-item: #f3f4f6; /* gray-100 */
            --bg-panel-item-hover: #d1d5db; /* gray-300 */
            --bg-select: #f3f4f6; /* gray-100 */
            --bg-cli-code: #f3f4f6; /* gray-100 */
            --text-primary: #1f2937; /* gray-800 */
            --text-secondary: #4b5563; /* gray-600 */
            --text-tertiary: #6b7280; /* gray-500 */
            --text-cli-code: #1f2937; /* gray-800 */
            --border-color: #d1d5db; /* gray-300 */
            --ring-offset-color: #e5e7eb;

            /* Alert Box Colors - Light Mode (FIXED) */
            --bg-alert-permitted: #d1fae5;      /* green-100 */
            --text-alert-permitted: #065f46;    /* green-800 */
            --border-alert-permitted: #6ee7b7; /* green-300 */
            --bg-alert-not-permitted: #ffedd5;  /* orange-100 */
            --text-alert-not-permitted: #9a3412; /* orange-800 */
            --border-alert-not-permitted: #fdba74; /* orange-300 */
        }

        .dark {
            /* Dark Theme Palette */
            --bg-body-gradient: linear-gradient(to bottom right, #111827, #1e293b);
            --bg-panel: rgba(17, 24, 39, 0.5);
            --bg-panel-item: rgba(55, 65, 81, 0.5); 
            --bg-panel-item-hover: rgba(55, 65, 81, 1);
            --bg-select: #1f2937;
            --bg-cli-code: #1f2937;
            --text-primary: #f3f4f6;
            --text-secondary: #d1d5db;
            --text-tertiary: #9ca3af;
            --text-cli-code: #f472b6;
            --border-color: #374151;
            --ring-offset-color: #1f2937;

            /* Alert Box Colors - Dark Mode */
            --bg-alert-permitted: rgba(16, 185, 129, 0.2);
            --text-alert-permitted: #a7f3d0;
            --border-alert-permitted: #10b981;
            --bg-alert-not-permitted: rgba(249, 115, 22, 0.2);
            --text-alert-not-permitted: #fdba74;
            --border-alert-not-permitted: #f97316;
        }

        /* General Variable Application */
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: var(--text-primary); }
        .dark body { background-image: var(--bg-body-gradient); }
        .bg-panel { background-color: var(--bg-panel); }
        .bg-panel-item { background-color: var(--bg-panel-item); }
        .bg-panel-item:hover { background-color: var(--bg-panel-item-hover); }
        .bg-select { background-color: var(--bg-select); }
        .bg-cli-code { background-color: var(--bg-cli-code); }
        .text-primary { color: var(--text-primary); }
        .text-secondary { color: var(--text-secondary); }
        .text-tertiary { color: var(--text-tertiary); }
        .text-cli-code { color: var(--text-cli-code); }
        .border-theme { border-color: var(--border-color); }
        .ring-offset-theme { --tw-ring-offset-color: var(--ring-offset-color); }

        /* Alert Box Theming */
        .alert-box {
            background-color: var(--bg-alert-color);
            color: var(--text-alert-color);
            border-color: var(--border-alert-color);
            border-width: 1px;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            line-height: 1.25rem;
            margin-bottom: 1.5rem;
        }
        .alert-permitted {
            --bg-alert-color: var(--bg-alert-permitted);
            --text-alert-color: var(--text-alert-permitted);
            --border-alert-color: var(--border-alert-permitted);
        }
        .alert-not-permitted {
            --bg-alert-color: var(--bg-alert-not-permitted);
            --text-alert-color: var(--text-alert-not-permitted);
            --border-alert-color: var(--border-alert-not-permitted);
        }

        /* Other styles */
        .font-viking { font-family: 'Almendra', serif; }
        .sortable-ghost { opacity: 0.4; background-color: #6366f1; color: white; }
        .sortable-chosen { cursor: grabbing; }
        .highlight-border { border-image-slice: 1; border-image-source: linear-gradient(to right, #4f46e5, #ec4899); }
        .action-item-hover:hover { border-color: #4f46e5 !important; }
        .custom-checkbox:checked, .custom-radio:checked { background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e"); border-color: #818cf8; background-color: #4f46e5; }
        .custom-radio:checked { background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3ccircle cx='8' cy='8' r='3'/%3e%3c/svg%3e"); }
    </style>
    <script>
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
</head>
<body class="bg-body text-primary transition-colors duration-300">
    <div class="max-w-screen-xl mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-10 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-6">
            <div>
                <div class="flex items-center gap-4">
                    <img src="huginn.png" alt="Huginn Logo" class="w-20 h-20">
                    <h1 class="font-viking text-5xl sm:text-6xl font-normal text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-500 tracking-wider">Huginn</h1>
                </div>
                <p class="mt-2 ml-16 font-semibold text-transparent bg-clip-text bg-gradient-to-r from-purple-500 to-pink-600">On-chain polling for Cardano Governance.</p>
            </div>
            <div class="flex flex-col items-end gap-4 w-full sm:w-auto">
                 <button id="theme-toggle-btn" class="p-2 rounded-lg bg-gray-200 dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-700 transition">
                    <svg id="theme-icon-light" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 14.464A1 1 0 106.465 13.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm-1.414-2.12a1 1 0 010-1.414l.707-.707a1 1 0 111.414 1.414l-.707.707a1 1 0 01-1.414 0zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z"/></svg>
                    <svg id="theme-icon-dark" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                </button>
                <div class="flex items-center gap-3 sm:gap-4">
                    <div class="flex-grow sm:flex-shrink-0">
                        <label for="role-selector" class="sr-only">Select your role</label>
                        <select id="role-selector" class="w-full bg-select text-primary border-gray-400 dark:border-gray-600 rounded-lg py-2 pl-3 pr-8 focus:ring-purple-500 focus:border-purple-500 transition">
                            <option value="Stakeholder">Stakeholder</option>
                            <option value="DRep">DRep</option>
                            <option value="SPO">SPO</option>
                            <option value="CC">CC Member</option>
                        </select>
                    </div>
                    <button id="connect-wallet-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 whitespace-nowrap shadow-lg shadow-purple-900/40">
                        Connect Wallet
                    </button>
                </div>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="bg-panel backdrop-blur-sm p-6 rounded-2xl shadow-lg h-fit">
                <h2 class="text-2xl font-semibold mb-4 text-primary">Governance Actions</h2>
                <div id="governance-actions-list" class="space-y-3 max-h-[70vh] overflow-y-auto pr-2">
                </div>
            </div>

            <div class="lg:col-span-2 bg-panel backdrop-blur-sm p-6 rounded-2xl shadow-lg min-h-[60vh]">
                <div id="details-panel">
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const themeToggleButton = document.getElementById('theme-toggle-btn');
            const lightIcon = document.getElementById('theme-icon-light');
            const darkIcon = document.getElementById('theme-icon-dark');

            function updateThemeIcons() {
                if (document.documentElement.classList.contains('dark')) {
                    lightIcon.classList.remove('hidden');
                    darkIcon.classList.add('hidden');
                } else {
                    lightIcon.classList.add('hidden');
                    darkIcon.classList.remove('hidden');
                }
            }

            function toggleTheme() {
                document.documentElement.classList.toggle('dark');
                localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
                updateThemeIcons();
            }

            themeToggleButton.addEventListener('click', toggleTheme);
            updateThemeIcons();

            const mockGovernanceActions = [
                { txId: '28a99b422180816a7f833a69778a10bd86737526715f27668576409a7a7835dc', type: 'Info Action', metadata: { "674": { "msg": ["Poll: DRep Tooling Priorities"], "pollDetails": { "specVersion": "1.0", "type": "single-choice", "question": "Which DRep tooling area needs most focus?", "description": "This poll gauges sentiment on where to prioritize development for professional DRep tooling.", "options": ["Advanced Analytics", "Co-signer/Multi-sig Tools", "Communication Standards", "Delegation Management"], "maxSelections": 1, "eligibility": ["DRep"], "voteWeighting": "CredentialBased" }}}},
                { txId: 'a1b2c3d4e5f6a1b2c3d4e5f6a1b2c3d4e5f6a1b2c3d4e5f6a1b2c3d4e5f6a1b2', type: 'Info Action', metadata: { "674": { "msg": ["Poll: Cardano Summit 2026"], "pollDetails": { "specVersion": "1.0", "type": "multi-select", "question": "Where should Cardano Summit be hosted in 2026?", "description": "Select your top 3 preferred continents. Results will guide the Cardano Foundation.", "options": ["Africa", "Asia", "Europe", "North America", "South America", "Australia"], "maxSelections": 3, "voteWeighting": "StakeBased" }}}},
                { txId: '11aa22bb33cc44dd55ee66ff77gg88hh99ii00jj11kk22ll33mm44nn55oo66pp', type: 'Info Action', metadata: { "674": { "msg": ["Community Poll: Next Hackathon Theme"], "pollDetails": { "specVersion": "1.0", "type": "single-choice", "question": "What should the theme of the next official Cardano Hackathon be?", "description": "This is a grassroots poll to measure community interest. Votes from formal governance roles (DReps, SPOs, CCs) will not be counted in the official tally.", "options": ["Gaming & Metaverse", "Sustainable DeFi", "Real-World Asset Tokenization", "Decentralized Identity"], "maxSelections": 1, "eligibility": ["Stakeholder"], "voteWeighting": "CredentialBased" }}}},
                { txId: 'f0e1d2c3b4a5f0e1d2c3b4a5f0e1d2c3b4a5f0e1d2c3b4a5f0e1d2c3b4a5f0e1', type: 'Info Action', metadata: { "674": { "msg": ["Poll: Treasury Grant Focus"], "pollDetails": { "specVersion": "1.0", "type": "multi-select", "question": "What should be the top 2 priorities for treasury grants?", "description": "Select up to two areas you believe are most critical for ecosystem growth via treasury funding. Open to DReps and SPOs.", "options": ["DeFi Development", "RealFi & Identity Solutions", "Developer Tooling", "Community & Education", "Marketing & Adoption"], "maxSelections": 2, "eligibility": ["DRep", "SPO"], "voteWeighting": "StakeBased" }}}},
                { txId: 'c1d2e3f4a5b6c1d2e3f4a5b6c1d2e3f4a5b6c1d2e3f4a5b6c1d2e3f4a5b6c1d2', type: 'Hard-Fork Initiation', metadata: null },
                { txId: 'b2c3d4e5f6a1b2c3d4e5f6a1b2c3d4e5f6a1b2c3d4e5f6a1b2c3d4e5f6a1b2c3', type: 'No Confidence', metadata: { "674": { "msg": ["No confidence in current CC members"] }}},
                { txId: 'd3e4f5a6b1c2d3e4f5a6b1c2d3e4f5a6b1c2d3e4f5a6b1c2d3e4f5a6b1c2d3e4', type: 'Update to the Constitution', metadata: null },
                { txId: 'e4f5a6b1c2d3e4f5a6b1c2d3e4f5a6b1c2d3e4f5a6b1c2d3e4f5a6b1c2d3e4f5', type: 'Treasury Withdrawal', metadata: { "674": { "msg": ["Funding for Project Catalyst Round 15"] }}},
            ];

            let selectedOptions = [];
            let isWalletConnected = false;
            let currentAction = null;
            let sortableInstance = null;
            let currentUserRole = 'Stakeholder';

            const DOM = {
                actionsList: document.getElementById('governance-actions-list'),
                detailsPanel: document.getElementById('details-panel'),
                connectWalletBtn: document.getElementById('connect-wallet-btn'),
                roleSelector: document.getElementById('role-selector'),
            };
            
            window.copyToClipboard = (text, button) => {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.style.position = 'fixed';
                textArea.style.left = '-9999px';
                textArea.select();
                try {
                    document.execCommand('copy');
                    const originalText = button.textContent;
                    button.textContent = 'Copied!';
                    setTimeout(() => { button.textContent = originalText; }, 2000);
                } catch (err) { console.error('Failed to copy text: ', err); }
                document.body.removeChild(textArea);
            };

            function init() {
                renderActionsList();
                showWelcomeMessage();
                DOM.connectWalletBtn.addEventListener('click', handleWalletConnect);
                DOM.roleSelector.addEventListener('change', handleRoleChange);
            }

            function renderActionsList() {
                DOM.actionsList.innerHTML = '';
                mockGovernanceActions.forEach(action => {
                    const pollDetails = action.metadata?.['674']?.pollDetails;
                    const title = pollDetails ? pollDetails.question : action.metadata?.['674']?.msg?.[0] || action.type;
                    const actionEl = document.createElement('div');
                    actionEl.className = 'bg-panel-item p-4 rounded-lg border-2 border-transparent action-item-hover cursor-pointer transition';
                    actionEl.dataset.txId = action.txId;
                    actionEl.innerHTML = `
                        <div class="flex justify-between items-start">
                            <h3 class="font-semibold text-primary pr-2">${title}</h3>
                            ${pollDetails ? '<span class="text-xs bg-purple-600 text-white px-2 py-1 rounded-full whitespace-nowrap">Poll</span>' : ''}
                        </div>
                        <p class="text-sm text-tertiary mt-2">Type: ${action.type}</p>
                    `;
                    actionEl.addEventListener('click', () => handleActionSelect(action.txId));
                    DOM.actionsList.appendChild(actionEl);
                });
            }
            
            function showWelcomeMessage() {
                DOM.detailsPanel.innerHTML = `
                    <div class="text-center flex flex-col items-center justify-center h-full min-h-[50vh]">
                        <h3 class="font-viking text-4xl font-normal text-primary">Welcome to Huginn</h3>
                        <p class="text-tertiary mt-2 max-w-lg">Select a governance action from the list on the left to view its details or participate in a poll.</p>
                   </div>`;
            }

            function renderNonPollDetails(action) {
                const title = action.metadata?.['674']?.msg?.[0] || action.type;
                DOM.detailsPanel.innerHTML = `
                    <h2 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-500 to-pink-600 mb-2">${title}</h2>
                    <p class="text-tertiary mb-6">Type: ${action.type}</p>
                    <div class="bg-panel-item p-4 rounded-lg">
                        <p class="text-secondary font-semibold">Transaction ID:</p>
                        <p class="text-sm text-tertiary break-all">${action.txId}</p>
                        <p class="text-secondary font-semibold mt-4">Details:</p>
                        <p class="text-tertiary">This is a standard governance action. Voting is handled by DReps, SPOs, and CC Members through dedicated governance interfaces.</p>
                    </div>
                `;
            }

            function renderNonPollVotingUI(action) {
                const title = action.metadata?.['674']?.msg?.[0] || action.type;
                let voteButtonsHtml = (currentUserRole === 'CC') ? `
                    <button data-vote="yes" class="w-full text-white font-bold py-3 px-4 rounded-lg transition duration-300 bg-green-600 hover:bg-green-700 shadow-lg shadow-green-900/40">Vote Constitutional</button>
                    <button data-vote="no" class="w-full text-white font-bold py-3 px-4 rounded-lg transition duration-300 bg-red-600 hover:bg-red-700 shadow-lg shadow-red-900/40">Vote Unconstitutional</button>
                    <button data-vote="abstain" class="w-full text-white font-bold py-3 px-4 rounded-lg transition duration-300 bg-gray-600 hover:bg-gray-700 shadow-lg shadow-gray-900/40">Abstain</button>`
                    : `
                    <button data-vote="yes" class="w-full text-white font-bold py-3 px-4 rounded-lg transition duration-300 bg-green-600 hover:bg-green-700 shadow-lg shadow-green-900/40">Vote Yes</button>
                    <button data-vote="no" class="w-full text-white font-bold py-3 px-4 rounded-lg transition duration-300 bg-red-600 hover:bg-red-700 shadow-lg shadow-red-900/40">Vote No</button>
                    <button data-vote="abstain" class="w-full text-white font-bold py-3 px-4 rounded-lg transition duration-300 bg-gray-600 hover:bg-gray-700 shadow-lg shadow-gray-900/40">Vote Abstain</button>`;

                DOM.detailsPanel.innerHTML = `
                    <h2 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-500 to-pink-600 mb-2">${title}</h2>
                    <p class="text-tertiary mb-6">Type: ${action.type}</p>
                    <div class="bg-panel-item p-4 rounded-lg mb-6">
                        <p class="text-secondary font-semibold">Transaction ID:</p>
                        <p class="text-sm text-tertiary break-all">${action.txId}</p>
                    </div>
                    <h3 class="text-xl font-semibold text-primary mb-4">Cast Your Governance Vote as a ${currentUserRole}</h3>
                    <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4 mb-6" id="gov-vote-buttons">${voteButtonsHtml}</div>
                    <div id="manual-submission-details" class="hidden mt-6 space-y-4"></div>`;
                DOM.detailsPanel.querySelector('#gov-vote-buttons').addEventListener('click', (e) => {
                    const button = e.target.closest('button');
                    if(button) renderGovCliCommand(action, button.dataset.vote);
                });
            }

            function renderGovCliCommand(action, vote) {
                const manualDetailsEl = DOM.detailsPanel.querySelector('#manual-submission-details');
                const roleFlag = {'DRep': '--drep-verification-key-file path/to/drep.vkey', 'SPO': '--cold-verification-key-file path/to/pool.vkey', 'CC': '--cc-hot-verification-key-file path/to/cc.vkey'}[currentUserRole];
                const voteFlag = {'yes': '--vote-yes', 'no': '--vote-no', 'abstain': '--abstain'}[vote];
                const cliCommand = `cardano-cli governance action vote create \\\n    ${voteFlag} \\\n    --governance-action-tx-id ${action.txId} \\\n    --governance-action-index 0 \\\n    ${roleFlag} \\\n    --out-file ${currentUserRole.toLowerCase()}-gov-vote.json`;

                manualDetailsEl.innerHTML = `
                    <div class="border-t border-theme pt-6">
                        <h3 class="text-xl font-semibold text-purple-500">Manual Submission Guide for a ${currentUserRole}</h3>
                        <p class="text-tertiary mt-2">Use this command to create your vote file. After creating the file, you must include it in a transaction to submit your vote.</p>
                        <div class="relative bg-cli-code p-4 rounded-lg mt-4">
                            <button onclick="copyToClipboard(this.nextElementSibling.textContent, this)" class="absolute top-2 right-2 bg-gray-400 dark:bg-gray-600 hover:bg-gray-500 dark:hover:bg-gray-500 text-xs px-2 py-1 rounded">Copy</button>
                            <pre class="text-sm text-cli-code whitespace-pre-wrap break-all">${cliCommand}</pre>
                        </div>
                    </div>`;
                manualDetailsEl.classList.remove('hidden');
                DOM.detailsPanel.querySelectorAll('#gov-vote-buttons button').forEach(button => {
                    button.classList.remove('ring-2', 'ring-offset-2', 'ring-offset-theme', 'ring-purple-500');
                    if (button.dataset.vote === vote) button.classList.add('ring-2', 'ring-offset-2', 'ring-offset-theme', 'ring-purple-500');
                });
            }
            
            function getEligibilityMessage(eligibility, voteWeighting) {
                if (!eligibility || eligibility.length === 0) return { message: `This poll is open to all Ada holders. Votes are **${voteWeighting}**.`, permitted: true, className: 'alert-permitted' };
                const isStakeholderPoll = eligibility.includes('Stakeholder');
                let isPermitted = eligibility.includes(currentUserRole);
                let message = `This poll is restricted to: **${eligibility.join(', ')}**. Votes are **${voteWeighting}**.`;
                if (isStakeholderPoll && eligibility.length === 1) {
                    isPermitted = currentUserRole === 'Stakeholder';
                    message = `This is a community poll for all **Stakeholders**. Votes from registered DReps, SPOs, and CCs will not be counted. Vote weighting is **${voteWeighting}**.`;
                }
                const roleName = currentUserRole;
                if (isPermitted) message += ` As a **${roleName}**, your vote will be counted.`;
                else message += ` As a **${roleName}**, your vote will NOT be counted, but you can still submit it to voice your opinion.`;
                return { message, permitted: isPermitted, className: isPermitted ? 'alert-permitted' : 'alert-not-permitted' };
            }

            function renderPoll(action) {
                currentAction = action;
                const pollDetails = action.metadata['674'].pollDetails;
                selectedOptions = [];
                const { question, description, options, type, maxSelections, eligibility, voteWeighting } = pollDetails;
                const eligibilityInfo = getEligibilityMessage(eligibility, voteWeighting || 'StakeBased');
                const eligibilityMessageHtml = `<div class="alert-box ${eligibilityInfo.className}">${eligibilityInfo.message.replace(/\*\*(.*?)\*\*/g, '<strong class="font-semibold text-current">$1</strong>')}</div>`;
                const optionsHtml = options.map(opt => `<label class="flex items-center bg-panel-item p-3 rounded-lg hover:bg-panel-item-hover cursor-pointer transition-colors duration-200"><input type="${type === 'single-choice' ? 'radio' : 'checkbox'}" name="poll-option" value="${opt}" class="${type === 'single-choice' ? 'custom-radio' : 'custom-checkbox'} h-5 w-5 rounded-full bg-gray-300 dark:bg-gray-900 border-2 border-gray-400 dark:border-gray-600 text-purple-500 focus:ring-purple-500"><span class="ml-3 text-lg text-primary">${opt}</span></label>`).join('');
                DOM.detailsPanel.innerHTML = `
                    <h2 class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-500 to-pink-600 mb-2">${question}</h2>
                    <p class="text-tertiary mb-4">${description}</p>
                    ${eligibilityMessageHtml}
                    <fieldset id="poll-options-container" class="space-y-3 mb-6">${optionsHtml}</fieldset>
                    ${type === 'multi-select' ? `<div class="mb-6"><h3 class="text-lg font-medium text-primary mb-2">Your Ranked Selection (Top to Bottom)</h3><ul id="selected-options-list" class="bg-panel-item p-3 rounded-lg min-h-[50px]"><li class="text-tertiary">Select up to ${maxSelections} options to rank them here.</li></ul></div>` : ''}
                    <div id="selection-feedback" class="text-sm text-yellow-600 dark:text-yellow-400 mb-4 hidden"></div>
                    <div id="submission-container" class="hidden"><h3 class="text-lg font-medium text-primary mb-3">Submit Your Vote</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><button id="submit-wallet-btn" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 disabled:bg-gray-500 dark:disabled:bg-gray-600 disabled:cursor-not-allowed flex items-center justify-center shadow-lg shadow-teal-900/40">Submit with Wallet</button><button id="manual-submit-btn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300">Manual / CLI Submission</button></div><div id="submission-status" class="text-center mt-4"></div></div>
                    <div id="manual-submission-details" class="hidden mt-6 space-y-4"></div><div id="results-container" class="mt-8 hidden"></div>`;
                DOM.detailsPanel.querySelector('#poll-options-container').addEventListener('change', handleOptionChange);
            }
            
            function renderRankedList() {
                const listEl = DOM.detailsPanel.querySelector('#selected-options-list');
                if (!listEl) return;
                const maxSelections = currentAction.metadata['674'].pollDetails.maxSelections;
                if (selectedOptions.length === 0) { listEl.innerHTML = `<li class="text-tertiary">Select up to ${maxSelections} options to rank them here.</li>`; return; }
                listEl.innerHTML = '';
                selectedOptions.forEach((option, index) => {
                    const li = document.createElement('li');
                    li.innerHTML = `<span class="font-bold mr-2 text-purple-600 dark:text-purple-300">${index + 1}.</span> ${option}`;
                    li.className = 'bg-purple-200 dark:bg-purple-600/50 text-purple-900 dark:text-white p-2 rounded-md cursor-move';
                    li.dataset.id = option;
                    listEl.appendChild(li);
                });
                if (sortableInstance) sortableInstance.destroy();
                sortableInstance = new Sortable(listEl, { animation: 150, ghostClass: 'sortable-ghost', onEnd: () => { selectedOptions = Array.from(listEl.children).map(item => item.dataset.id.replace(/&amp;/g, '&')); renderRankedList(); }});
            }

            function renderManualSubmission() {
                const manualDetailsEl = DOM.detailsPanel.querySelector('#manual-submission-details');
                if (!manualDetailsEl) return;
                const metadata = { "674": { "msg": [`Response to poll: ${currentAction.metadata['674'].pollDetails.question}`], "voteFor": { "actionTxId": currentAction.txId, "selection": selectedOptions }}};
                const metadataString = JSON.stringify(metadata);
                let cliCommand = (currentUserRole === 'Stakeholder') ? `cardano-cli transaction build \\\n    # Replace with --mainnet for main network\n    --testnet \\\n    # Replace with your wallet's UTXO\n    --tx-in <Your-UTXO> \\\n    # Replace with your wallet's address\n    --tx-out <Your-Address>+1000000 \\\n    # Replace with your wallet's change address\n    --change-address <Your-Address> \\\n    # The poll vote metadata\n    --metadata-json-string '${metadataString}' \\\n    --out-file poll-vote.txbody` : `cardano-cli governance action vote create \\\n    # Recommended vote for Info Action polls\n    --abstain \\\n    --governance-action-tx-id ${currentAction.txId} \\\n    --governance-action-index 0 \\\n    ${{'DRep': '--drep-verification-key-file path/to/drep.vkey', 'SPO': '--cold-verification-key-file path/to/pool.vkey', 'CC': '--cc-hot-verification-key-file path/to/cc.vkey'}[currentUserRole]} \\\n    --out-file ${currentUserRole.toLowerCase()}-poll-vote.json \\\n    # Poll response attached as metadata\n    --metadata-json-string '${metadataString}'`;
                manualDetailsEl.innerHTML = `
                    <div class="border-t border-theme pt-6">
                        <h3 class="text-xl font-semibold text-purple-600 dark:text-purple-400">Manual Submission Guide for a ${currentUserRole}</h3>
                        <p class="text-tertiary mt-2">Use this self-contained command to cast your vote. Replace placeholder paths with your own.</p>
                        <div class="relative bg-cli-code p-4 rounded-lg mt-4">
                            <button onclick="copyToClipboard(this.nextElementSibling.textContent, this)" class="absolute top-2 right-2 bg-gray-400 dark:bg-gray-600 hover:bg-gray-500 dark:hover:bg-gray-500 text-xs px-2 py-1 rounded">Copy</button>
                            <pre class="text-sm text-cli-code whitespace-pre-wrap break-all">${cliCommand}</pre>
                        </div>
                        <p class="text-tertiary mt-2 text-sm">${currentUserRole === 'Stakeholder' ? 'After building, sign and submit the transaction.' : 'This creates a vote body file, which you then include in a transaction build.'}</p>
                    </div>`;
                manualDetailsEl.classList.remove('hidden');
            }

            function handleActionSelect(txId) {
                document.querySelectorAll('#governance-actions-list > div').forEach(el => {
                    el.classList.remove('highlight-border', 'border-2');
                    el.classList.add('border-transparent');
                    if (el.dataset.txId === txId) {
                         el.classList.remove('border-transparent');
                         el.classList.add('highlight-border', 'border-2');
                    }
                });
                currentAction = mockGovernanceActions.find(a => a.txId === txId);
                const pollDetails = currentAction.metadata?.['674']?.pollDetails;
                if (pollDetails) renderPoll(currentAction);
                else if (['DRep', 'SPO', 'CC'].includes(currentUserRole)) renderNonPollVotingUI(currentAction);
                else renderNonPollDetails(currentAction);
            }

            function handleWalletConnect() {
                if (isWalletConnected) return;
                isWalletConnected = true;
                DOM.connectWalletBtn.classList.replace('bg-purple-600', 'bg-teal-600');
                DOM.connectWalletBtn.classList.replace('hover:bg-purple-700', 'hover:bg-teal-700');
                DOM.connectWalletBtn.innerHTML = `<span>Connected: addr1qy...a7p</span>`;
                updateSubmissionUI();
            }

            function handleRoleChange(e) {
                currentUserRole = e.target.value;
                if (currentAction) {
                    const pollDetails = currentAction.metadata?.['674']?.pollDetails;
                     if (pollDetails) renderPoll(currentAction);
                     else if (['DRep', 'SPO', 'CC'].includes(currentUserRole)) renderNonPollVotingUI(currentAction);
                     else renderNonPollDetails(currentAction);
                }
            }

            function handleOptionChange(e) {
                const { value, checked, type } = e.target;
                const maxSelections = currentAction.metadata['674'].pollDetails.maxSelections;
                if (type === 'radio') selectedOptions = [value];
                else if (type === 'checkbox') {
                    if (checked) {
                        if (selectedOptions.length < maxSelections) selectedOptions.push(value);
                        else { e.target.checked = false; showFeedback(`You can select a maximum of ${maxSelections} options.`); }
                    } else selectedOptions = selectedOptions.filter(opt => opt !== value);
                }
                if(type === 'multi-select') renderRankedList();
                updateSubmissionUI();
            }

            function handleSubmitWallet() {
                const statusEl = DOM.detailsPanel.querySelector('#submission-status');
                DOM.detailsPanel.querySelector('#submit-wallet-btn').disabled = true;
                DOM.detailsPanel.querySelector('#manual-submit-btn').disabled = true;
                statusEl.textContent = 'Please sign the transaction in your wallet...';
                setTimeout(() => {
                    const fakeTxId = [...Array(64)].map(() => Math.floor(Math.random() * 16).toString(16)).join('');
                    const scanUrl = `https://sancho.cardanoscan.io/transaction/${fakeTxId}`;
                    statusEl.innerHTML = `<div class="bg-teal-100 dark:bg-teal-900/50 border border-teal-300 dark:border-teal-700 text-teal-800 dark:text-teal-300 text-sm p-3 rounded-lg"><span>Vote successfully submitted!</span><a href="${scanUrl}" target="_blank" class="text-purple-600 dark:text-purple-400 hover:text-purple-500 dark:hover:text-purple-300 underline font-semibold ml-2">View Receipt</a></div>`;
                    showMockResults();
                }, 2000);
            }

            function updateSubmissionUI() {
                const submissionContainer = DOM.detailsPanel.querySelector('#submission-container');
                if (!submissionContainer) return;
                const pollDetails = currentAction?.metadata?.['674']?.pollDetails;
                if (!pollDetails || selectedOptions.length === 0) { submissionContainer.classList.add('hidden'); return; }
                submissionContainer.classList.remove('hidden');
                DOM.detailsPanel.querySelector('#submit-wallet-btn').disabled = !isWalletConnected;
                DOM.detailsPanel.querySelector('#submit-wallet-btn').addEventListener('click', handleSubmitWallet, { once: true });
                DOM.detailsPanel.querySelector('#manual-submit-btn').addEventListener('click', renderManualSubmission, { once: true });
            }
            
            function showFeedback(message) {
                const feedbackEl = DOM.detailsPanel.querySelector('#selection-feedback');
                if (!feedbackEl) return;
                feedbackEl.textContent = message;
                feedbackEl.classList.remove('hidden');
                setTimeout(() => feedbackEl.classList.add('hidden'), 2500);
            }

            function showMockResults() {
                const resultsContainer = DOM.detailsPanel.querySelector('#results-container');
                if (!resultsContainer) return;
                const resultsOutput = document.createElement('div');
                resultsOutput.className = 'space-y-4';
                resultsContainer.innerHTML = '<h3 class="text-xl font-semibold text-primary mb-4 border-t border-theme pt-6">Live Poll Results</h3>';
                resultsContainer.appendChild(resultsOutput);
                resultsContainer.classList.remove('hidden');
                const mockResults = currentAction.metadata['674'].pollDetails.options.reduce((acc, opt) => { acc[opt] = Math.floor(Math.random() * 500) + 50; return acc; }, {});
                selectedOptions.forEach(opt => mockResults[opt] += 1);
                const totalVotes = Object.values(mockResults).reduce((sum, val) => sum + val, 0);
                resultsOutput.innerHTML = '';
                for (const [option, votes] of Object.entries(mockResults)) {
                    const percentage = totalVotes > 0 ? ((votes / totalVotes) * 100).toFixed(1) : 0;
                    resultsOutput.innerHTML += `<div><div class="flex justify-between items-center mb-1 font-medium text-primary"><span>${option.replace(/&/g, '&amp;')}</span><span class="text-tertiary">${votes} votes</span></div><div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5"><div class="bg-gradient-to-r from-purple-500 to-pink-500 h-2.5 rounded-full" style="width: ${percentage}%"></div></div></div>`;
                }
            }

            init();
        });
    </script>
</body>
</html>
